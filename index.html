<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probation Scheduler | คุมประพฤติ เขต 2</title>
  <meta name="description" content="คำนวนวันรายงานตัวผู้ถูกคุมประพฤติ จังหวัดเชียงราย เขต 2 - ครบ 4 ครั้งภายใน 1 ปี พร้อมวันล็อกอำเภอเวียงชัย" />
  <meta name="theme-color" content="#0d3c91"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="probation-logo-32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="probation-logo-48.png">
  <link rel="icon" type="image/png" sizes="192x192" href="probation-logo-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="probation-logo-180.png">
  <style>
    :root{ --bg:#f5f8ff; --panel:#ffffff; --ink:#0b2a5a; --muted:#5b6b86; --line:#d7e0f2;
           --blue:#174ea6; --blue-2:#0d3c91; --gold:#d6b24a; --shadow:0 10px 25px rgba(13,60,145,.09); }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    @media(max-width:960px){.app{grid-template-columns:0 1fr}.side{position:fixed;z-index:40;inset:0 30% 0 0;transform:translateX(-100%);transition:.25s ease}.side.open{transform:none}.side-mask{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(2px);display:none}.side.open + .main .side-mask{display:block}}
    .side{background:linear-gradient(180deg,#103a8a,#0d3c91); color:#ecf2ff; box-shadow:var(--shadow)}
    .side .brand{display:flex;align-items:center;gap:10px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.12)}
    .brand img{width:46px;height:46px;border-radius:10px;box-shadow:0 6px 20px rgba(13,60,145,.35);border:3px solid #f8fbff;outline:2px solid #0b2a5a;background:#0d3c91;object-fit:contain}
    .nav{padding:10px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#eaf2ff;text-decoration:none}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav .head{margin:8px 12px 6px;color:#cbd8ff;font-size:12px;letter-spacing:.5px;text-transform:uppercase}
    .main{display:grid;grid-template-rows:auto 1fr}
    .top{background:var(--panel);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:30}
    .hamb{display:none}
    @media(max-width:960px){.hamb{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#fff;margin-right:8px}}
    .top .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f2f6ff);color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.2s ease;box-shadow:0 1px 3px rgba(13,60,145,.06)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(13,60,145,.15)}
    .btn.primary{background:linear-gradient(180deg,#1d5ac4,#134aa4);color:#fff;border-color:#134aa4}
    .content{padding:18px;display:grid;gap:18px}
    .grid{display:grid;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    label span{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink)}
    input[type="checkbox"]{width:18px;height:18px}
    .row{display:grid;gap:10px;margin:10px 0}
    .row.inline{grid-template-columns:22px 1fr;align-items:center}
    .note{border:1px dashed var(--line);background:#f9fbff;padding:10px;border-radius:12px;color:#5b6b86}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:880px}
    thead th{background:linear-gradient(180deg,#e8f0ff,#dfe9ff);color:#0b2a5a;border-bottom:1px solid var(--line);position:sticky;top:0}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left}
    tbody tr:nth-child(even){background:#f7f9ff}
    .right{text-align:right}
  
/* ==== Monthly Quickview Floating UI ==== */
.quickview-fab{
  position:fixed; right:20px; bottom:24px; z-index:60;
  display:flex; align-items:center; gap:10px;
  background:linear-gradient(135deg,#0d47a1,#1976d2);
  color:#fff; border:none; border-radius:999px; padding:10px 14px;
  box-shadow:0 12px 30px rgba(3,43,108,.24), 0 6px 12px rgba(3,43,108,.18);
  font-weight:600; letter-spacing:.2px; cursor:pointer; transition:.25s transform;
}
.quickview-fab:hover{ transform:translateY(-2px); }
.quickview-fab svg{ width:20px; height:20px; opacity:.92 }

.quickview-panel{
  position:fixed; right:20px; bottom:80px; z-index:59; width:min(380px,88vw);
  background:#ffffff; border:1px solid #e7eef8; border-radius:16px;
  box-shadow:0 20px 40px rgba(12,46,96,.18),0 8px 16px rgba(12,46,96,.12);
  padding:14px; display:none;
  backdrop-filter:saturate(140%) blur(6px);
}
.quickview-panel.open{ display:block; animation:panelIn .18s ease-out }
@keyframes panelIn{ from{ transform:translateY(8px); opacity:.0 } to{ transform:translateY(0); opacity:1 } }

.quickview-title{
  display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;
}
.quickview-title h4{ margin:0; font-weight:700; color:#0a2257 }
.quickview-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

.qv-chip{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; padding:10px 12px; border:1px solid #e6eef8; border-radius:12px;
  background:linear-gradient(180deg,#f9fbff,#f6f9ff);
  color:#0d2a5a; font-weight:600; cursor:pointer;
  box-shadow:0 1px 0 #eef3fb inset; transition:.2s transform, .25s box-shadow, .25s background;
}
.qv-chip .sub{ font-size:.82rem; color:#5b7cad; font-weight:600; background:#eaf2ff; padding:2px 8px; border-radius:999px }
.qv-chip:hover{
  transform:translateY(-1px);
  box-shadow: 0 10px 22px rgba(22,58,126,.10), 0 1px 0 #eef3fb inset;
  background:linear-gradient(180deg,#fefeff,#f6faff);
}
.qv-close{
  border:none; background:transparent; color:#385ea9; font-weight:700; cursor:pointer;
}
@media (max-width: 680px){
  .quickview-grid{ grid-template-columns:1fr; }
}

</style>

<style>
/* --- Pretty button group for quick views --- */
.btn-group{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0 0}
.btn-chip{appearance:none;border:1px solid #d4dcf1;background:#fff;color:#1b3a8a;
  padding:8px 12px;border-radius:999px;font-size:14px;line-height:1;cursor:pointer;
  box-shadow:0 1px 2px rgba(0,10,60,.06)}
.btn-chip:hover{background:#f3f6ff;border-color:#b9c6ff}
.btn-chip .tag{display:inline-flex;align-items:center;justify-content:center;
  min-width:22px;height:22px;border-radius:11px;background:#e9eefc;color:#203a86;
  font-weight:600;margin-left:8px;padding:0 8px;font-size:12px}
dialog .month-grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
@media (min-width:860px){dialog .month-grid{grid-template-columns:repeat(3,minmax(180px,1fr))}}
</style>

<style>
/* --- v24: move เวียงชัย/พาน into FAB & tidy fonts --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
html,body{font-family:'Inter',"Noto Sans Thai",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
/* hide legacy inline chips/buttons for เวียงชัย/พาน to avoid duplicates */
#btn-view-2569,#btn-view-2570,#btn-view-phan-2569,#btn-view-phan-2570,
.btn-group:has(#btn-view-2569), .btn-group:has(#btn-view-phan-2569){display:none!important}

/* polish FAB panel look */
.quickview-title h4{font-weight:700;letter-spacing:.2px}
.qv-chip{font-weight:600}
.qv-chip .sub{font-weight:700}
.quickview-fab{font-weight:700}
</style>

<!-- v24 enhancement: add WiangChai/Phan entries into FAB and rename อ.พาน -> พาน -->
<script>
(function(){
  function qv(label, id){
    return `<button class="qv-chip" id="${id}"><span>${label}</span><span class="sub">ปี 69–70</span></button>`;
  }
  function addToFab(){
    const panel = document.querySelector('.quickview-panel .quickview-grid');
    if(!panel) return;
    // avoid duplicate injection
    if(document.getElementById('qv-wiangchai') || document.getElementById('qv-phan')) return;
    // Insert two new chips at the top row
    panel.insertAdjacentHTML('afterbegin', qv('เวียงชัย','qv-wiangchai'));
    panel.insertAdjacentHTML('afterbegin', qv('พาน','qv-phan'));
    // Wire actions: open their existing modals (2569 as entry point)
    const mWC = document.getElementById('modal-2569');     // เวียงชัย 2569 modal
    const mPH = document.getElementById('modal-phan-2569'); // พาน 2569 modal
    const go = (dlg)=>{ if(dlg && dlg.showModal) dlg.showModal(); };
    const wcBtn = document.getElementById('qv-wiangchai');
    const phBtn = document.getElementById('qv-phan');
    if(wcBtn) wcBtn.addEventListener('click', ()=>go(mWC));
    if(phBtn) phBtn.addEventListener('click', ()=>go(mPH));
  }

  function renamePhanText(){
    // Buttons
    ['btn-view-phan-2569','btn-view-phan-2570'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.innerHTML = el.innerHTML.replace(/อ\.พาน/g,'พาน');
    });
    // Modal headings (strong inside dialogs)
    const d1 = document.querySelector('#modal-phan-2569 .modal-head strong');
    const d2 = document.querySelector('#modal-phan-2570 .modal-head strong');
    if(d1) d1.textContent = 'วันรายเดือน พาน (ปี 2569)';
    if(d2) d2.textContent = 'วันรายเดือน พาน (ปี 2570)';
  }

  document.addEventListener('DOMContentLoaded',()=>{
    renamePhanText();
    addToFab();
  });
})();
</script>

</head>
<body>
<div class="app">
  <aside class="side" id="sidebar">
    <div class="brand">
      <img src="probation-logo-green.png" alt="Probation Scheduler Logo"/>
      <div>
        <div style="font-weight:700;letter-spacing:.2px">คุมประพฤติ เขต 2</div>
        <div style="font-size:12px;color:#cbd8ff">Probation Scheduler</div>
      </div>
    </div>
    <div class="nav">
      <div class="head">เมนู</div>
      <a href="#" onclick="document.getElementById('startDate').focus()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#eaf2ff" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        ตั้งค่าวันเริ่ม
      </a>
      <a href="#" onclick="document.getElementById('presetArea').focus()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#eaf2ff" stroke-width="2"><path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        เลือกอำเภอ
      </a>
      <a href="#" onclick="showHelp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#eaf2ff" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 1 1 5.91 1c0 2-3 2-3 4"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        วิธีใช้งาน
      </a>
    </div>
  </aside>

  <section class="main">
    <header class="top">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="hamb" onclick="document.getElementById('sidebar').classList.toggle('open')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0b2a5a" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <h1 style="font-size:18px">Website คำนวนวันรายงานตัวผู้ถูกคุมประพฤติ จังหวัดเชียงราย เขต 2</h1>
      </div>
      <div class="actions">
        <button class="btn" id="btn-view-2569">วันเวียงชัย 2569</button>
        <button class="btn" id="btn-view-2570">วันเวียงชัย 2570</button>
        <button class="btn" id="btn-copy">คัดลอก CSV</button>
        <button class="btn" id="btn-download">ดาวน์โหลด CSV</button>
        <button class="btn primary" id="btn-print">พิมพ์</button>
      </div>
    </header>

    <div class="content">
      <div class="grid">
        <div class="card">
          <h2>ตั้งค่าหลัก</h2>
          <div class="row">
            <label><span>วันที่มีคำพิพากษา</span><input type="date" id="startDate" /></label>
          </div>
          <div class="row">
            <label><span>ช่วงห่าง (เดือน)</span><input type="number" id="intervalMonths" min="1" value="4"/></label>
          </div>
          <div class="row">
            <label><span>พื้นที่ (ตัวเลือกวันประจำเดือน)</span>
              <select id="presetArea">
                <option value="">— ไม่ใช้ตัวเลือกอำเภอ —</option>
                <option value="wiangchai-686970">เวียงชัย (รวมปี 2568–2569–2570)</option>
              
  <option value="phan-686970">พาน (รวมปี 2568–2569–2570)</option>
                <option value="wiangchiangrung-686970">เวียงเชียงรุ้ง (รวมปี 2568–2569–2570)</option>
                <option value="doiluang-686970">ดอยหลวง (รวมปี 2568–2569–2570)</option>
                <option value="maesuai-686970">แม่สรวย (รวมปี 2568–2569–2570)</option>
            
                <option value="maelao-686970">แม่ลาว (รวมปี 2568–2569–2570)</option>
            
                <option value="wiangpapao-686970">เวียงป่าเป้า (รวมปี 2569–2570)</option>
            
                <option value="watpangae-686970">วัดป่าแงะ (รวมปี 2569–2570)</option>
            </select>
            </label>
          </div>
          <div class="row inline">
            <input type="checkbox" id="lockDay" />
            <label for="lockDay">ล็อกวันที่ของเดือน (เช่น ทุกครั้งวันที่ 5)</label>
          </div>
          <div class="row" id="lockDayWrap" style="display:none">
            <label><span>กำหนดวันที่ (1–31)</span><input type="number" id="lockedDay" min="1" max="31" value="5"/>
              <div class="note">*ถ้าเดือนไม่มีวันดังกล่าว จะใช้วันสุดท้ายของเดือน</div>
            </label>
          </div>
          <div class="row inline">
            <input type="checkbox" id="shiftBiz" checked />
            <label for="shiftBiz">ถ้าตรงเสาร์-อาทิตย์/วันหยุดราชการ ให้เลื่อนไปวันทำการถัดไป</label>
          </div>

          <div class="note">
            กติกา: ต้องได้ <b>4 ครั้งภายใน 1 ปี</b> เสมอ • เวียงชัยใช้ “วันล็อก” ของเดือน • ถ้าคิว 4 เดือนไม่พอ ระบบจะจัดรอบใหม่ให้อยู่ก่อนครบปี (เดือนที่ 11)
          </div>
        </div>

        <div class="card">
          <h2>การคำนวณวันรายงานตัวผู้ถูกคุมประพฤติจังหวัดเชียงราย เขตพื้นที่ 2</h2>
          <div class="row">
            <label><span>จำนวนครั้งรายงานตัว</span><input type="number" id="count" min="1" max="4" value="4"/></label>
          </div>
          <div class="note">ระบบจะจัดให้ครบ 4 ครั้งภายใน 1 ปี โดยอาจย่นรอบและ/หรือขยับ “ครั้งที่ 4” ไม่เกินเดือนที่ 11</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>ผลการคำนวณ</strong>
          <span id="limitNote" style="color:var(--muted);font-size:12px">โซนเวลา: Asia/Bangkok</span>
        </div>
        <div class="table-wrap">
          <table id="resultTable">
            <thead><tr><th>ครั้ง</th><th>วันที่รายงานตัว (ไทย)</th><th>วันที่ (ISO)</th><th>วัน</th><th class="right">เหลืออีก (วัน)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="side-mask" onclick="document.getElementById('sidebar').classList.remove('open')"></div>
  </section>
</div>

<dialog id="modal-2569">
  <div class="modal-head">
    <strong>วันรายเดือน อำเภอเวียงชัย (ปี 2569)</strong>
    <button class="btn" id="close-2569">ปิด</button>
  </div>
  <div class="modal-body">
    <div class="month-grid" id="grid-2569"></div>
    <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" id="copy-2569">คัดลอกข้อความ</button></div>
  </div>
</dialog>

<dialog id="modal-2570">
  <div class="modal-head">
    <strong>วันรายเดือน อำเภอเวียงชัย (ปี 2570)</strong>
    <button class="btn" id="close-2570">ปิด</button>
  </div>
  <div class="modal-body">
    <div class="month-grid" id="grid-2570"></div>
    <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" id="copy-2570">คัดลอกข้อความ</button></div>
  </div>
</dialog>

<script>
  if (location.protocol.startsWith('http')) {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  }

  const tz='Asia/Bangkok';
  const presets={
  'maesuai-686970': { years: {
    2025: [21,18,18,22,20,17,15,19,16,21,18,16], // 2568
    2026: [20,17,17,21,19,16,14,18,15,13,17,15], // 2569
    2027: [19,16,16,20,18,15,20,17,21,19,16,21]  // 2570
  }},"wiangchai-686970":{years:{2025:[20,17,24,28,19,23,29,25,22,27,17,22],2026:[26,23,30,27,25,29,27,31,28,22,23,28],2027:[25,23,22,26,25,21,26,23,27,26,22,27]}}};

  const startOfDay=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x};
  const TH_HOLIDAYS = new Set([
  // 2025 (พ.ศ.2568) — ตามมติ ครม. + วันหยุดชดเชย/เพิ่มเติม (ตัวอย่างชุดครอบคลุมทั่วไป)
  '2025-01-01',                         /* New Year */
  '2025-02-12',                         /* Makha Bucha (approx; update if announced) */
  '2025-04-06','2025-04-07',            /* Chakri + Substitute */
  '2025-04-13','2025-04-14','2025-04-15', /* Songkran */
  '2025-05-01','2025-05-05',            /* Labour + Coronation(Sub) */
  '2025-06-03',                         /* HM Queen Suthida */
  '2025-07-18','2025-07-19',            /* Asanha Bucha + Buddhist Lent (approx) */
  '2025-07-28',                         /* HM King Maha Vajiralongkorn */
  '2025-08-12',                         /* HM Queen Mother */
  '2025-10-13','2025-10-23',            /* King Bhumibol Memorial, Chulalongkorn Day */
  '2025-12-05','2025-12-10','2025-12-31',

  // 2026 (พ.ศ.2569)
  '2026-01-01',
  '2026-02-01',                         /* Makha (approx) */
  '2026-04-06',
  '2026-04-13','2026-04-14','2026-04-15',
  '2026-05-01','2026-05-05',            /* Coronation day */
  '2026-06-03',
  '2026-07-27','2026-07-28','2026-07-29','2026-07-30', /* HM King + Asanha/Lent window (approx) */
  '2026-08-12',
  '2026-10-13','2026-10-23',
  '2026-12-05','2026-12-10','2026-12-31',

  // 2027 (พ.ศ.2570)
  '2027-01-01',
  '2027-02-20','2027-02-21',            /* Makha + possible Substitute (approx) */
  '2027-04-06',
  '2027-04-13','2027-04-14','2027-04-15',
  '2027-05-01','2027-05-05',
  '2027-06-03',
  '2027-07-19','2027-07-20','2027-07-28', /* Asanha/Lent + HM King */
  '2027-08-12',
  '2027-10-13','2027-10-23',
  '2027-12-05','2027-12-10','2027-12-31'
]);
const isWeekend=d=>d.getDay()===0||d.getDay()===6;
const isThaiHoliday=d=>TH_HOLIDAYS.has(fmtISO(d));
const isNonWorkingDay=d=>isWeekend(d)||isThaiHoliday(d);
const nextBusinessDay=d=>{const x=new Date(d);while(isNonWorkingDay(x)){x.setDate(x.getDate()+1)}return x};
  /* overridden by Thai-holiday-aware nextBusinessDay above */
  const lastDayOfMonth=(y,m)=>new Date(y,m+1,0).getDate();
  const addMonthsClamp=(date,months,desiredDay=null)=>{const y=date.getFullYear(),m=date.getMonth(),d=date.getDate();const tm=m+months,ty=y+Math.floor(tm/12),mm=((tm%12)+12)%12;const want=desiredDay??d;const max=lastDayOfMonth(ty,mm);const fd=Math.min(want,max);const out=new Date(ty,mm,fd);out.setHours(0,0,0,0);return out};
  const fmtTH=d=>new Intl.DateTimeFormat('th-TH',{dateStyle:'full',timeZone:tz}).format(d);
  const fmtISO=d=>{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`};
  const weekdayTH=d=>new Intl.DateTimeFormat('th-TH',{weekday:'long',timeZone:tz}).format(d);
  const monthsBetween=(a,b)=>(b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth());

  const startDateEl=document.getElementById('startDate'),
        intervalEl=document.getElementById('intervalMonths'),
        presetAreaEl=document.getElementById('presetArea'),
        lockDayEl=document.getElementById('lockDay'),
        lockedDayEl=document.getElementById('lockedDay'),
        shiftBizEl=document.getElementById('shiftBiz'),
        countEl=document.getElementById('count'),
        tbody=document.querySelector('#resultTable tbody'),
        limitNote=document.getElementById('limitNote');

  (function init(){
    const today=startOfDay(new Date());
    startDateEl.value=fmtISO(today);
    renderModal(2026,document.getElementById('grid-2569'));
    renderModal(2027,document.getElementById('grid-2570'));
    updateSchedule();
    ['input','change'].forEach(ev=>[startDateEl,intervalEl,presetAreaEl,lockDayEl,lockedDayEl,shiftBizEl,countEl].forEach(el=>el.addEventListener(ev,updateSchedule)));
    lockDayEl.addEventListener('change',()=>{document.getElementById('lockDayWrap').style.display=lockDayEl.checked?'':'none'});
    document.getElementById('btn-print').addEventListener('click',()=>window.print());
    document.getElementById('btn-copy').addEventListener('click',copyCSV);
    document.getElementById('btn-download').addEventListener('click',downloadCSV);
    document.getElementById('btn-view-2569').addEventListener('click',()=>document.getElementById('modal-2569').showModal());
    document.getElementById('btn-view-2570').addEventListener('click',()=>document.getElementById('modal-2570').showModal());
    document.getElementById('close-2569').addEventListener('click',()=>document.getElementById('modal-2569').close());
    document.getElementById('close-2570').addEventListener('click',()=>document.getElementById('modal-2570').close());
    document.getElementById('copy-2569').addEventListener('click',()=>copyYear(2026,'เวียงชัย ปี 2569'));
    document.getElementById('copy-2570').addEventListener('click',()=>copyYear(2027,'เวียงชัย ปี 2570'));
  })();

  function showHelp(){
    alert('วิธีใช้:\\n1) ตั้งวันที่มีคำพิพากษา\\n2) เลือกช่วงห่าง (ปกติ 4 เดือน)\\n3) เลือกพื้นที่เวียงชัยหากต้องใช้วันล็อกของอำเภอ\\n4) กำหนดจำนวนครั้ง (4)\\nระบบจะจัดให้ครบ 4 ครั้งภายใน 1 ปี ถ้าเกินปีจะปรับรอบและขยับครั้งที่ 4 ให้ก่อนครบปี');
  }

  function renderModal(year, gridEl){
    gridEl.innerHTML='';
    const monthsTH=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
    const arr=presets['wiangchai-686970'].years[year];
    monthsTH.forEach((name,i)=>{
      const div=document.createElement('div'); div.className='pill';
      div.innerHTML=`<span>${i+1}. ${name}</span><strong>${arr[i]}</strong>`; gridEl.appendChild(div);
    });
  }

  async function copyYear(year, title){
    const monthsTH=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    const arr=presets['wiangchai-686970'].years[year];
    const txt=monthsTH.map((m,i)=>`${m} ${arr[i]}`).join(', ');
    try{ await navigator.clipboard.writeText(`${title}: ${txt}`); alert('คัดลอกแล้ว'); }catch(e){ alert('คัดลอกไม่สำเร็จ'); }
  }

  function toCSV(rows){
    const header=["ครั้ง","วันที่รายงานตัว (ไทย)","วันที่ (ISO)","วัน","เหลืออีก (วัน)"];
    const body=rows.map(r=>[r.index,r.th,r.iso,r.weekday,r.daysLeft]);
    const all=[header,...body].map(line=>line.map(x=>(''+x).replaceAll('\"','\"\"')).map(x=>`\"${x}\"`).join(',')).join('\\n');
    return all;
  }
  async function copyCSV(){ const rows=computeRows(); const csv=toCSV(rows); try{ await navigator.clipboard.writeText(csv); alert('คัดลอก CSV แล้ว'); }catch(e){ alert('คัดลอกไม่สำเร็จ'); } }
  function downloadCSV(){ const rows=computeRows(); const csv=toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='probation-schedule-skydash-v13.csv'; a.click(); URL.revokeObjectURL(url); }

  function wiangchaiLocked(y,m){const arr=presets['wiangchai-686970'].years[y]; if(!arr) return null; const d=Math.min(arr[m], lastDayOfMonth(y,m)); const dt=new Date(y,m,d); dt.setHours(0,0,0,0); return dt }
  function applyPreset(dateObj){ const dt=wiangchaiLocked(dateObj.getFullYear(), dateObj.getMonth()); return dt??dateObj }

  function computeRows(){
    const start=startOfDay(new Date(startDateEl.value));
    const gap=Math.max(1,parseInt(intervalEl.value||'4',10));
    const count=Math.min(4,Math.max(1,parseInt(countEl.value||'4',10)));
    const usePreset=!!presetAreaEl.value;
    const lockedDay=(lockDayEl.checked && !usePreset) ? Math.max(1,Math.min(31,parseInt(lockedDayEl.value||'5',10))) : null;
    const shiftBiz=shiftBizEl.checked;
    const oneYearLimit=addMonthsClamp(start,12,null);
    const lastAllowed=addMonthsClamp(start,11,null);

    let first;
    if(usePreset){
      const curLocked=applyPreset(start);
      let base=start;
      if(start.getTime()>curLocked.getTime()){ base=addMonthsClamp(start,1,null); }
      first=addMonthsClamp(new Date(base.getFullYear(), base.getMonth(), 1), gap, 1);
      first=applyPreset(first);
    }else{
      first=addMonthsClamp(start, gap, lockedDay);
    }

    let rows=[]; let cur=new Date(first);
    const push=(dt)=>{ let d=new Date(dt); if(usePreset) d=applyPreset(d); else if(lockedDay!=null){ const y=d.getFullYear(),m=d.getMonth(); d=new Date(y,m,Math.min(lockedDay,lastDayOfMonth(y,m))); } if(shiftBiz) d=nextBusinessDay(d); if(d>oneYearLimit) return false; rows.push(d); return true; };
    if(!push(cur)) rows=[];
    while(rows.length<count){ cur=addMonthsClamp(cur, gap, lockedDay); if(!push(cur)) break; }

    const okLast = rows.length===count && rows[rows.length-1] <= lastAllowed;
    if(!okLast){
      let targetLast = usePreset ? applyPreset(lastAllowed) : new Date(lastAllowed);
      if(!usePreset && lockedDay!=null){ targetLast = new Date(lastAllowed.getFullYear(), lastAllowed.getMonth(), Math.min(lockedDay,lastDayOfMonth(lastAllowed.getFullYear(), lastAllowed.getMonth()))); }
      if(shiftBiz) targetLast=nextBusinessDay(targetLast);

      const earliestFirst=new Date(first);
      const span=Math.max(0, monthsBetween(earliestFirst, targetLast));
      let step=Math.max(1, Math.floor((span-1)/3));
      let t1=new Date(earliestFirst);
      let t2=addMonthsClamp(t1, step, lockedDay);
      let t3=addMonthsClamp(t2, step, lockedDay);
      let t4=new Date(targetLast);
      if(usePreset){ t1=applyPreset(t1); t2=applyPreset(t2); t3=applyPreset(t3); t4=applyPreset(t4); }
      if(shiftBiz){ t1=nextBusinessDay(t1); t2=nextBusinessDay(t2); t3=nextBusinessDay(t3); t4=nextBusinessDay(t4); }
      rows=[t1,t2,t3,t4].filter(d=>d<=oneYearLimit);
    }

    const today=startOfDay(new Date());
    limitNote.textContent=`จำกัดภายใน 1 ปี (ไม่เกิน ${fmtTH(oneYearLimit)})`;
    return rows.map((d,i)=>({index:i+1, th:fmtTH(d), iso:fmtISO(d), weekday:weekdayTH(d), daysLeft:Math.ceil((d-today)/(1000*60*60*24))}));
  }

  function updateSchedule(){
    const rows=computeRows();
    tbody.innerHTML='';
    const frag=document.createDocumentFragment();
    rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.index}</td><td>${r.th}</td><td>${r.iso}</td><td>${r.weekday}</td><td class="right">${r.daysLeft}</td>`; frag.appendChild(tr)});
    tbody.appendChild(frag);
  }
</script>

<script>
// ---- Add Amphoe Phan (อ.พาน) fixed monthly day presets (B.E. 2568-2570) ----
(function(){
  const phan = {
    years: {
      2025: [23,20,20,18,22,19,17,21,18,16,20,18], // 2568
      2026: [22,19,19,23,21,18,16,20,17,15,20,17], // 2569
      2027: [21,18,22,20,17,22,19,23,21,18,23,23]  // 2570
    }
  };
  window.presets = window.presets || {};
  if (!window.presets["phan-686970"]) {
    window.presets["phan-686970"] = phan;
  }
  // Quick view helpers for Amphoe Phan
  function renderModalGeneric(presetKey, year, gridEl){
    if (!gridEl) return;
    gridEl.innerHTML='';
    const monthsTH=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
    const arr = (window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[year]) || [];
    monthsTH.forEach((name,i)=>{
      const div=document.createElement('div'); div.className='pill';
      const val = (arr[i] != null ? arr[i] : '-');
      div.innerHTML=`<span>${i+1}. ${name}</span><strong>${val}</strong>`;
      gridEl.appendChild(div);
    });
  }
  function copyYearGeneric(presetKey, year, label){
    const monthsTH=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    const arr = (window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[year]) || [];
    const txt = monthsTH.map((m,i)=>`${m} ${arr[i] ?? '-'}`).join(', ');
    navigator.clipboard.writeText(`${label}: ${txt}`).then(()=>alert('คัดลอกแล้ว'),()=>alert('คัดลอกไม่สำเร็จ'));
  }
  window.__phanHelpers = { renderModalGeneric, copyYearGeneric };
  document.addEventListener('DOMContentLoaded', ()=>{
    // 3) inject buttons (next to existing tool buttons)
    const host = document.querySelector('.export-row, .top-actions, .tools') || document.querySelector('.app') || document.body;
    const wrap = document.createElement('div');
    wrap.style.marginTop = '8px';
    wrap.innerHTML = `
      <button class="btn" id="btn-view-phan-2569">วันพาน 2569</button>
      <button class="btn" id="btn-view-phan-2570" style="margin-left:6px">วันพาน 2570</button>
    `;
    host.appendChild(wrap);

    // 4) inject modals if not exist
    if (!document.getElementById('modal-phan-2569')) {
      const dlg1 = document.createElement('dialog');
      dlg1.id = 'modal-phan-2569';
      dlg1.innerHTML = \`
        <div class="modal-head">
          <strong>วันรายเดือน อำเภอพาน (ปี 2569)</strong>
          <button class="btn" id="close-phan-2569">ปิด</button>
        </div>
        <div class="modal-body">
          <div class="month-grid" id="grid-phan-2569"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="copy-phan-2569">คัดลอกข้อความ</button>
          </div>
        </div>\`;
      document.body.appendChild(dlg1);
    }
    if (!document.getElementById('modal-phan-2570')) {
      const dlg2 = document.createElement('dialog');
      dlg2.id = 'modal-phan-2570';
      dlg2.innerHTML = \`
        <div class="modal-head">
          <strong>วันรายเดือน อำเภอพาน (ปี 2570)</strong>
          <button class="btn" id="close-phan-2570">ปิด</button>
        </div>
        <div class="modal-body">
          <div class="month-grid" id="grid-phan-2570"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="copy-phan-2570">คัดลอกข้อความ</button>
          </div>
        </div>\`;
      document.body.appendChild(dlg2);
    }

    // render grids
    __phanHelpers.renderModalGeneric('phan-686970', 2026, document.getElementById('grid-phan-2569'));
    __phanHelpers.renderModalGeneric('phan-686970', 2027, document.getElementById('grid-phan-2570'));

    // wire buttons
    document.getElementById('btn-view-phan-2569').addEventListener('click', ()=>document.getElementById('modal-phan-2569').showModal());
    document.getElementById('btn-view-phan-2570').addEventListener('click', ()=>document.getElementById('modal-phan-2570').showModal());
    document.getElementById('close-phan-2569').addEventListener('click', ()=>document.getElementById('modal-phan-2569').close());
    document.getElementById('close-phan-2570').addEventListener('click', ()=>document.getElementById('modal-phan-2570').close());
    document.getElementById('copy-phan-2569').addEventListener('click', ()=>__phanHelpers.copyYearGeneric('phan-686970', 2026, 'พาน ปี 2569'));
    document.getElementById('copy-phan-2570').addEventListener('click', ()=>__phanHelpers.copyYearGeneric('phan-686970', 2027, 'พาน ปี 2570'));
  });
})();
</script>


<!-- PHAN QUICK VIEW INJECT START -->
<script>
(function(){
  const phanPresetKey = 'phan-686970';
  const monthsTH=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];

  function renderModalGeneric(presetKey, year, gridEl){
    if (!gridEl) return;
    gridEl.innerHTML='';
    const arr = (window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[year]) || [];
    monthsTH.forEach((name,i)=>{
      const div=document.createElement('div'); div.className='pill';
      const val = (arr[i] != null ? arr[i] : '-');
      div.innerHTML=`<span>${i+1}. ${name}</span><strong>${val}</strong>`;
      gridEl.appendChild(div);
    });
  }

  async function copyYearGeneric(presetKey, year, label){
    const short=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    const arr = (window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[year]) || [];
    const txt = short.map((m,i)=>`${m} ${arr[i] ?? '-'}`).join(', ');
    try { await navigator.clipboard.writeText(`${label}: ${txt}`); alert('คัดลอกแล้ว'); }
    catch (e) { alert('คัดลอกไม่สำเร็จ'); }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    // --- Button group ---
    const host = document.querySelector('.export-row, .top-actions, .tools') || document.querySelector('.app') || document.body;
    const group = document.createElement('div');
    group.className='btn-group';
    group.innerHTML = `
      <button class="btn-chip" id="btn-view-phan-2569">อ.พาน <span class="tag">ปี 2569</span></button>
      <button class="btn-chip" id="btn-view-phan-2570">อ.พาน <span class="tag">ปี 2570</span></button>
    `;
    host.appendChild(group);

    // --- Modals ---
    if (!document.getElementById('modal-phan-2569')) {
      const dlg = document.createElement('dialog');
      dlg.id='modal-phan-2569';
      dlg.innerHTML = `
        <div class="modal-head"><strong>วันรายเดือน อำเภอพาน (ปี 2569)</strong>
          <button class="btn" id="close-phan-2569">ปิด</button></div>
        <div class="modal-body">
          <div class="month-grid" id="grid-phan-2569"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="copy-phan-2569">คัดลอกข้อความ</button>
          </div>
        </div>`;
      document.body.appendChild(dlg);
    }
    if (!document.getElementById('modal-phan-2570')) {
      const dlg = document.createElement('dialog');
      dlg.id='modal-phan-2570';
      dlg.innerHTML = `
        <div class="modal-head"><strong>วันรายเดือน อำเภอพาน (ปี 2570)</strong>
          <button class="btn" id="close-phan-2570">ปิด</button></div>
        <div class="modal-body">
          <div class="month-grid" id="grid-phan-2570"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="copy-phan-2570">คัดลอกข้อความ</button>
          </div>
        </div>`;
      document.body.appendChild(dlg);
    }

    // Render
    renderModalGeneric(phanPresetKey, 2026, document.getElementById('grid-phan-2569'));
    renderModalGeneric(phanPresetKey, 2027, document.getElementById('grid-phan-2570'));

    // Wire
    document.getElementById('btn-view-phan-2569').addEventListener('click', ()=>document.getElementById('modal-phan-2569').showModal());
    document.getElementById('btn-view-phan-2570').addEventListener('click', ()=>document.getElementById('modal-phan-2570').showModal());
    document.getElementById('close-phan-2569').addEventListener('click', ()=>document.getElementById('modal-phan-2569').close());
    document.getElementById('close-phan-2570').addEventListener('click', ()=>document.getElementById('modal-phan-2570').close());
    document.getElementById('copy-phan-2569').addEventListener('click', ()=>copyYearGeneric(phanPresetKey, 2026, 'พาน ปี 2569'));
    document.getElementById('copy-phan-2570').addEventListener('click', ()=>copyYearGeneric(phanPresetKey, 2027, 'พาน ปี 2570'));
  });
})();
</script>
<!-- PHAN QUICK VIEW INJECT END -->


<!-- PHAN DATA OVERRIDE (from images 2569/2570) -->
<script>
(function(){
  window.presets = window.presets || {};
  if (!window.presets['phan-686970']) window.presets['phan-686970'] = { years: {} };
  window.presets['phan-686970'].years[2026] = [22,19,19,23,21,18,16,20,17,15,20,17]; // 2569
  window.presets['phan-686970'].years[2027] = [21,18,22,20,17,22,19,23,21,18,23,23]; // 2570
})();
</script>


<!-- MOVE PHAN BUTTON GROUP UNDER RESULTS -->
<script>
(function(){
  function findResultsCard(){
    // Look for a heading containing "ผลการคำนวณ"
    const hs = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    for (const h of hs){
      if ((h.textContent||'').trim().includes('ผลการคำนวณ')){
        // Prefer closest card-like container
        return h.closest('.card, .panel, .box, .section, .result, .results') || h.parentElement;
      }
    }
    // Fallback: find a table that looks like results (has 4 rows of schedule)
    const tables = Array.from(document.querySelectorAll('table'));
    if (tables.length) return tables[0].parentElement;
    return null;
  }
  function moveGroup(){
    const group = document.querySelector('.btn-group');
    if (!group) return;
    const anchor = findResultsCard();
    if (!anchor) return;
    // Insert a margin spacer and move
    const holder = document.createElement('div');
    holder.style.margin = '16px 0 8px 0';
    holder.appendChild(group);
    anchor.parentNode.insertBefore(holder, anchor.nextSibling);
  }
  window.addEventListener('DOMContentLoaded', moveGroup);
})();
</script>


<!-- UNIFY QUICK VIEW GROUP: move WiangChai buttons under results with Phan -->
<script>
(function(){
  function findResultsCard(){
    const hs = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    for (const h of hs){
      if ((h.textContent||'').trim().includes('ผลการคำนวณ')){
        return h.closest('.card, .panel, .box, .section, .result, .results') || h.parentElement;
      }
    }
    const tables = Array.from(document.querySelectorAll('table'));
    if (tables.length) return tables[0].parentElement;
    return null;
  }
  function ensureGroup(anchor){
    let group = document.getElementById('quick-group');
    if (!group){
      group = document.createElement('div');
      group.className = 'btn-group';
      group.id = 'quick-group';
      const holder = document.createElement('div');
      holder.style.margin = '16px 0 12px 0';
      holder.appendChild(group);
      anchor.parentNode.insertBefore(holder, anchor.nextSibling);
    }
    return group;
  }
  function chipify(btn, label, year){
    if (!btn) return;
    btn.classList.remove('btn');
    btn.classList.add('btn-chip');
    btn.textContent = label + ' ';
    const tag = document.createElement('span');
    tag.className='tag';
    tag.textContent='ปี ' + year;
    btn.appendChild(tag);
  }
  function moveWiangChai(group){
    const wc2569 = document.getElementById('btn-view-2569');
    const wc2570 = document.getElementById('btn-view-2570');
    if (wc2569){ chipify(wc2569, 'เวียงชัย', '2569'); group.appendChild(wc2569); }
    if (wc2570){ chipify(wc2570, 'เวียงชัย', '2570'); group.appendChild(wc2570); }
  }
  function mergeExistingGroup(group){
    const oldGroup = document.querySelector('.btn-group');
    if (oldGroup && oldGroup !== group){
      while (oldGroup.firstChild){
        group.appendChild(oldGroup.firstChild);
      }
      oldGroup.remove();
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{
    const anchor = findResultsCard();
    if (!anchor) return;
    const group = ensureGroup(anchor);
    // Move existing phan chip-group in if present
    mergeExistingGroup(group);
    // Move WiangChai buttons into the same group
    moveWiangChai(group);
  });
})();
</script>


<!-- PHAN CORRECTION: use Phan days (2568-2570) and lock like Wiang Chai -->
<script>
(function(){
  // 1) Correct Phan days per images
  const PHAN = {
    years: {
      2025: [23,20,20,18,22,19,17,21,18,16,20,18], // 2568
      2026: [22,19,19,23,21,18,16,20,17,15,20,17], // 2569
      2027: [21,18,22,20,17,22,19,23,21,18,23,23]  // 2570
    }
  };
  window.presets = window.presets || {};
  window.presets['phan-686970'] = PHAN; // force override
  // 2) When clicking Phan quick view, also switch area to Phan so schedule uses Phan lock-days
  function sel(v){
    const sel = document.getElementById('presetArea');
    if (!sel) return;
    if (sel.value !== v){
      sel.value = v;
      sel.dispatchEvent(new Event('change', {bubbles:true}));
      sel.dispatchEvent(new Event('input', {bubbles:true}));
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{
    const b2569 = document.getElementById('btn-view-phan-2569');
    const b2570 = document.getElementById('btn-view-phan-2570');
    if (b2569) b2569.addEventListener('click', ()=> sel('phan-686970'));
    if (b2570) b2570.addEventListener('click', ()=> sel('phan-686970'));
  });
})();
</script>


<!-- DISTRICT-SCOPED LOCKING: each district locks to its own monthly days -->
<script>
(function(){
  // Ensure both presets exist (don't overwrite WiangChai if already defined)
  window.presets = window.presets || {};
  window.presets['wiangchai-686970'] = window.presets['wiangchai-686970'] || {years:{}};
  window.presets['phan-686970'] = window.presets['phan-686970'] || {years:{}};

  // Helpers
  function lastDayOfMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function lockedByPresetKey(presetKey, y, m){
    const arr = window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[y];
    if (!arr) return null;
    const d = Math.min(arr[m], lastDayOfMonth(y,m));
    if (!d || isNaN(d)) return null;
    const dt = new Date(y, m, d);
    dt.setHours(0,0,0,0);
    return dt;
  }

  // Override applyPreset globally (the scheduler calls this)
  window.addEventListener('DOMContentLoaded', ()=>{
    const presetAreaEl = document.getElementById('presetArea');
    if (!presetAreaEl) return;
    window.applyPreset = function(dateObj){
      const key = presetAreaEl.value;
      if (!key) return dateObj;
      return lockedByPresetKey(key, dateObj.getFullYear(), dateObj.getMonth()) || dateObj;
    };

    // Clicking quick-view should also set the correct area (so table locks accordingly)
    function selectArea(val){
      if (presetAreaEl.value !== val){
        presetAreaEl.value = val;
        presetAreaEl.dispatchEvent(new Event('change', {bubbles:true}));
        presetAreaEl.dispatchEvent(new Event('input', {bubbles:true}));
      }
    }
    const wc2569 = document.getElementById('btn-view-2569');
    const wc2570 = document.getElementById('btn-view-2570');
    if (wc2569) wc2569.addEventListener('click', ()=>selectArea('wiangchai-686970'));
    if (wc2570) wc2570.addEventListener('click', ()=>selectArea('wiangchai-686970'));

    const ph2569 = document.getElementById('btn-view-phan-2569');
    const ph2570 = document.getElementById('btn-view-phan-2570');
    if (ph2569) ph2569.addEventListener('click', ()=>selectArea('phan-686970'));
    if (ph2570) ph2570.addEventListener('click', ()=>selectArea('phan-686970'));
  });
})();
</script>


<!-- WIANGCHAI DATA OVERRIDE per user: 2569 & 2570 -->
<script>
(function(){
  window.presets = window.presets || {};
  if (!window.presets['wiangchai-686970']) window.presets['wiangchai-686970'] = {years:{}};
  // 2569 -> year 2026
  window.presets['wiangchai-686970'].years[2026] = [26,23,30,27,25,29,27,31,28,22,23,28];
  // 2570 -> year 2027
  window.presets['wiangchai-686970'].years[2027] = [25,23,22,26,25,21,26,23,27,26,22,27];
})();
</script>


<!-- === FIX: district-scoped presets & Maesuai lock-days (B.E.2568-2570) === -->
<script>
(function(){
  // 1) แม่สรวย: วันล็อกตามชุดที่กำหนด (คริสต์ศักราช: 2568->2025, 2569->2026, 2570->2027)
  window.presets = window.presets || {};
  window.presets['maesuai-686970'] = {
    years: {
      2025: [21,18,18,22,20,17,15,19,16,21,18,16], // พ.ศ. 2568
      2026: [20,17,17,21,19,16,14,18,15,13,17,15], // พ.ศ. 2569
      2027: [19,16,16,20,18,15,20,17,21,19,16,21]  // พ.ศ. 2570
    }
  };

  // 2) เวียงเชียงรุ้ง / ดอยหลวง: กัน cross-flow โดยตั้ง key ว่างไว้
  window.presets['wiangchiangrung-686970'] = window.presets['wiangchiangrung-686970'] || { years: {} };
  window.presets['doiluang-686970']        = window.presets['doiluang-686970']        || { years: {} };

  // helper
  const lastDayOfMonth = (y,m)=> new Date(y, m+1, 0).getDate();
  function lockedByPresetKey(presetKey, y, m){
    const arr = window.presets[presetKey] && window.presets[presetKey].years && window.presets[presetKey].years[y];
    if (!arr) return null;
    const d = Math.min(arr[m], lastDayOfMonth(y,m));
    if (!d || isNaN(d)) return null;
    const dt = new Date(y, m, d);
    dt.setHours(0,0,0,0);
    return dt;
  }

  // 3) override applyPreset ให้ยึดเฉพาะอำเภอที่เลือกใน presetArea เท่านั้น
  window.addEventListener('DOMContentLoaded', ()=>{
    const presetAreaEl = document.getElementById('presetArea');
    if (!presetAreaEl) return;
    window.applyPreset = function(dateObj){
      const key = presetAreaEl.value;
      if (!key) return dateObj;
      return lockedByPresetKey(key, dateObj.getFullYear(), dateObj.getMonth()) || dateObj;
    };
  });
})();
</script>
<!-- === /FIX === -->


<!-- === Mae Lao (แม่ลาว) preset: fixed arrays; scoped applyPreset === -->
<script>
(function(){
  window.presets = window.presets || {};
  window.presets['maelao-686970'] = {
    years: {
      2025: [23,20,20,18,22,19,17,21,18,16,20,18], // B.E.2568
      2026: [13,10,10,8,12,9,7,11,8,6,10,8],       // B.E.2569
      2027: [12,9,9,7,11,8,13,10,14,12,9,14]       // B.E.2570
    }
  };

  function lockedByPresetKey(presetKey, y, m){
    const p = window.presets[presetKey];
    if(!p || !p.years || !p.years[y]) return null;
    const arr = p.years[y];
    const last = new Date(y, m+1, 0).getDate();
    const d = Math.min(arr[m], last);
    if(!d || isNaN(d)) return null;
    const dt = new Date(y, m, d); dt.setHours(0,0,0,0); return dt;
  }

  window.addEventListener('DOMContentLoaded', () => {
    const presetArea = document.getElementById('presetArea');
    if(!presetArea) return;
    // Override applyPreset so it always uses the currently selected district only
    window.applyPreset = function(d){
      const key = presetArea.value;
      if(!key) return d;
      return lockedByPresetKey(key, d.getFullYear(), d.getMonth()) || d;
    };
  });
})();
</script>
<!-- END MAE LAO BLOCK -->


<!-- === FIX v21: Wiang Pa Pao & Wat Pa Ngae dedicated presets (B.E.2569–2570) + district-scoped applyPreset === -->
<script>
(function(){
  window.presets = window.presets || {};

  // เวียงป่าเป้า (ที่ว่าการอำเภอ)
  // 2569 -> 2026: 8,12,12,9,14,11,9,13,10,8,12,9
  // 2570 -> 2027: 14,11,11,8,13,10,15,13,16,14,11,16
  window.presets['wiangpapao-686970'] = {
    years: {
      2026: [8,12,12,9,14,11,9,13,10,8,12,9],
      2027: [14,11,11,8,13,10,15,13,16,14,11,16]
    }
  };

  // วัดป่าแงะ (ป่าแงะ)
  // 2569 -> 2026: 29,26,26,24,28,25,23,27,24,26,26,24
  // 2570 -> 2027: 28,25,25,29,27,24,29,26,30,28,25,30
  window.presets['watpangae-686970'] = {
    years: {
      2026: [29,26,26,24,28,25,23,27,24,26,26,24],
      2027: [28,25,25,29,27,24,29,26,30,28,25,30]
    }
  };

  // --- prevent cross-flow: applyPreset uses ONLY the selected district ---
  function lastDayOfMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function lockedByPresetKey(presetKey, y, m){
    const preset = window.presets[presetKey];
    if(!preset || !preset.years || !preset.years[y]) return null;
    const arr = preset.years[y];
    const d = Math.min(arr[m], lastDayOfMonth(y,m));
    if (!d || isNaN(d)) return null;
    const dt = new Date(y, m, d); dt.setHours(0,0,0,0);
    return dt;
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const presetAreaEl = document.getElementById('presetArea');
    if (!presetAreaEl) return;
    window.applyPreset = function(dateObj){
      const key = presetAreaEl.value;
      if (!key) return dateObj;
      return lockedByPresetKey(key, dateObj.getFullYear(), dateObj.getMonth()) || dateObj;
    };
  });
})();
</script>


<!-- seed WCR/DoiLuang presets if missing -->
<script>
(function(){
  window.presets = window.presets || {};
  if(!window.presets['wiangchiangrung-686970'] || !window.presets['wiangchiangrung-686970'].years){
    window.presets['wiangchiangrung-686970'] = { years: {} };
  }
  if(!window.presets['doiluang-686970'] || !window.presets['doiluang-686970'].years){
    window.presets['doiluang-686970'] = { years: {} };
  }
  // Fill only if missing (ปี 2569=2026, 2570=2027)
  const wcr = window.presets['wiangchiangrung-686970'].years;
  const dl  = window.presets['doiluang-686970'].years;
  if(!wcr[2026]) wcr[2026] = [13,10,17,21,13,16,21,18,15,20,11,15];
  if(!wcr[2027]) wcr[2027] = [18,15,15,19,17,14,19,16,20,18,15,20];
  if(!dl[2026])  dl[2026]  = [13,10,17,21,13,16,21,18,15,20,11,15];
  if(!dl[2027])  dl[2027]  = [18,15,15,19,17,14,19,16,20,18,15,20];
})();
</script>


<script>
(function(){
  function tableFor(arr){
    const months = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    if(!arr) return '<div style="color:#b91c1c">ยังไม่ได้ตั้งค่า</div>';
    return '<table style="border-collapse:collapse;min-width:300px;border:1px solid #e6eef8;border-radius:10px;overflow:hidden">'+
           '<thead><tr><th style="background:#f5f9ff;padding:8px 10px;text-align:left">เดือน</th><th style="background:#f5f9ff;padding:8px 10px;text-align:center">วัน</th></tr></thead>'+
           '<tbody>'+arr.map((d,i)=>`<tr><td style="padding:6px 10px;border-bottom:1px solid #eef2f7">${months[i]}</td><td style="padding:6px 10px;border-bottom:1px solid #eef2f7;text-align:center">${d}</td></tr>`).join('')+
           '</tbody></table>';
  }
  function openWindow(title, sections){
    const w=window.open('','_blank','width=900,height=640,scrollbars=yes');
    let html='<div style="font-family:system-ui,Segoe UI,Roboto,TH Sarabun New,Arial;padding:12px 16px;line-height:1.6">';
    html+=`<h3 style="margin:0 0 8px 0">${title}</h3>`;
    html+='<div style="display:grid;gap:14px">';
    sections.forEach(s=>{
      html+=`<div style="padding:10px;border:1px solid #e6eef8;border-radius:10px;background:#f7fbff">
               <div style="font-weight:600;margin-bottom:6px">${s.header}</div>
               <div style="display:flex;gap:12px;flex-wrap:wrap">
                 <div><div class="muted" style="margin-bottom:4px">ปี 2569</div>${tableFor(s.y2026)}</div>
                 <div><div class="muted" style="margin-bottom:4px">ปี 2570</div>${tableFor(s.y2027)}</div>
               </div>
             </div>`;
    });
    html+='</div></div>';
    w.document.write('<title>'+title+'</title>'+html);
    w.document.close();
  }

  function attach(){
    // Read presets
    const P = (window.presets||{});

    // Buttons
    const bWPP = document.getElementById('btn-view-wpp');
    const bWPN = document.getElementById('btn-view-wpn');
    const bMSR = document.getElementById('btn-view-msr');
    const bMLA = document.getElementById('btn-view-mla');
    const bWCRDL = document.getElementById('btn-view-wcrdl');

    if(bWPP) bWPP.addEventListener('click', ()=>{
      openWindow('วันรายเดือน: เวียงป่าเป้า (ปี 69–70)', [{
        header: 'เวียงป่าเป้า',
        y2026: P['wiangpapao-686970'] && P['wiangpapao-686970'].years && P['wiangpapao-686970'].years[2026],
        y2027: P['wiangpapao-686970'] && P['wiangpapao-686970'].years && P['wiangpapao-686970'].years[2027]
      }]);
    });

    if(bWPN) bWPN.addEventListener('click', ()=>{
      openWindow('วันรายเดือน: วัดป่าแงะ (ปี 69–70)', [{
        header: 'วัดป่าแงะ',
        y2026: P['watpangae-686970'] && P['watpangae-686970'].years && P['watpangae-686970'].years[2026],
        y2027: P['watpangae-686970'] && P['watpangae-686970'].years && P['watpangae-686970'].years[2027]
      }]);
    });

    if(bMSR) bMSR.addEventListener('click', ()=>{
      openWindow('วันรายเดือน: แม่สรวย (ปี 69–70)', [{
        header: 'แม่สรวย',
        y2026: P['maesuai-686970'] && P['maesuai-686970'].years && P['maesuai-686970'].years[2026],
        y2027: P['maesuai-686970'] && P['maesuai-686970'].years && P['maesuai-686970'].years[2027]
      }]);
    });

    if(bMLA) bMLA.addEventListener('click', ()=>{
      openWindow('วันรายเดือน: แม่ลาว (ปี 69–70)', [{
        header: 'แม่ลาว',
        y2026: P['maelao-686970'] && P['maelao-686970'].years && P['maelao-686970'].years[2026],
        y2027: P['maelao-686970'] && P['maelao-686970'].years && P['maelao-686970'].years[2027]
      }]);
    });

    if(bWCRDL) bWCRDL.addEventListener('click', ()=>{
      openWindow('วันรายเดือน: เวียงเชียงรุ้ง / ดอยหลวง (ปี 69–70)', [
        {
          header: 'เวียงเชียงรุ้ง',
          y2026: P['wiangchiangrung-686970'] && P['wiangchiangrung-686970'].years && P['wiangchiangrung-686970'].years[2026],
          y2027: P['wiangchiangrung-686970'] && P['wiangchiangrung-686970'].years && P['wiangchiangrung-686970'].years[2027]
        },
        {
          header: 'ดอยหลวง',
          y2026: P['doiluang-686970'] && P['doiluang-686970'].years && P['doiluang-686970'].years[2026],
          y2027: P['doiluang-686970'] && P['doiluang-686970'].years && P['doiluang-686970'].years[2027]
        }
      ]);
    });
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', attach);
  else attach();
})();
</script>


<!-- Floating Monthly Quickview UI -->
<button class="quickview-fab" id="qv-launch">
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1.5A2.5 2.5 0 0 1 22 6.5v12A2.5 2.5 0 0 1 19.5 21h-15A2.5 2.5 0 0 1 2 18.5v-12A2.5 2.5 0 0 1 4.5 4H6V3a1 1 0 0 1 1-1Zm13.5 8H3.5v8.5c0 .552.448 1 1 1h15c.552 0 1-.448 1-1V10ZM7 6H5.5c-.552 0-1 .448-1 1V8h15V7.5c0-.552-.448-1-1-1H17V8a1 1 0 1 1-2 0V6H9v2a1 1 0 1 1-2 0V6Z"/></svg>
  ดูวันรายเดือน
</button>
<div class="quickview-panel" id="qv-panel" role="dialog" aria-modal="true" aria-labelledby="qv-title">
  <div class="quickview-title">
    <h4 id="qv-title">ดูวันรายเดือน ปี 2569–2570</h4>
    <button class="qv-close" id="qv-close">ปิด</button>
  </div>
  <div class="quickview-grid">
    <div class="qv-chip" id="btn-view-wpp"><span>เวียงป่าเป้า</span><span class="sub">ปี 69–70</span></div>
    <div class="qv-chip" id="btn-view-wpn"><span>วัดป่าแงะ</span><span class="sub">ปี 69–70</span></div>
    <div class="qv-chip" id="btn-view-msr"><span>แม่สรวย</span><span class="sub">ปี 69–70</span></div>
    <div class="qv-chip" id="btn-view-mla"><span>แม่ลาว</span><span class="sub">ปี 69–70</span></div>
    <div class="qv-chip" id="btn-view-wcrdl"><span>เวียงเชียงรุ้ง / ดอยหลวง</span><span class="sub">ปี 69–70</span></div>
  </div>
</div>


<script>
(function(){
  const launch = document.getElementById('qv-launch');
  const panel  = document.getElementById('qv-panel');
  const closeB = document.getElementById('qv-close');
  if(launch && panel){
    launch.addEventListener('click', ()=> panel.classList.add('open'));
  }
  if(closeB) closeB.addEventListener('click', ()=> panel.classList.remove('open'));
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape') panel.classList.remove('open');
  });
})();
</script>

</body>
</html>
