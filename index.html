<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Probation Scheduler | เขต 2 </title>
  <meta name="theme-color" content="#0d3c91"/>
  <link rel="icon" type="image/png" href="probation-logo.png">
  <style>
    :root{
      --bg:#f5f8ff; --panel:#ffffff; --ink:#0b2a5a; --muted:#5b6b86; --line:#d7e0f2;
      --blue:#174ea6; --blue-2:#0d3c91; --shadow:0 10px 25px rgba(13,60,145,.09);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    @media(max-width:960px){.app{grid-template-columns:0 1fr}.side{position:fixed;z-index:40;inset:0 30% 0 0;transform:translateX(-100%);transition:.25s}.side.open{transform:none}.side-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none}.side.open + .main .side-mask{display:block}}
    .side{background:linear-gradient(180deg,#103a8a,#0d3c91); color:#ecf2ff; box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:10px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.12)}
    .brand img{width:46px;height:46px;border-radius:10px;box-shadow:0 6px 20px rgba(13,60,145,.35);border:3px solid #f8fbff;outline:2px solid #0b2a5a;background:#0d3c91;object-fit:contain}
    .nav{padding:10px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#eaf2ff;text-decoration:none}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav .head{margin:8px 12px 6px;color:#cbd8ff;font-size:12px;letter-spacing:.5px;text-transform:uppercase}
    .main{display:grid;grid-template-rows:auto 1fr}
    .top{background:var(--panel);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:30}
    .hamb{display:none}
    @media(max-width:960px){.hamb{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#fff;margin-right:8px}}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f2f6ff);color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.2s;box-shadow:0 1px 3px rgba(13,60,145,.06)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(13,60,145,.15)}
    .btn.primary{background:linear-gradient(180deg,#1d5ac4,#134aa4);color:#fff;border-color:#134aa4}
    .content{padding:18px;display:grid;gap:18px}
    .grid{display:grid;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    label span{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#var(--ink)}
    input[type="checkbox"]{width:18px;height:18px}
    .row{display:grid;gap:10px;margin:10px 0}
    .row.inline{grid-template-columns:22px 1fr;align-items:center}
    .note{border:1px dashed var(--line);background:#f9fbff;padding:10px;border-radius:12px;color:#5b6b86}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:880px}
    thead th{background:linear-gradient(180deg,#e8f0ff,#dfe9ff);color:#0b2a5a;border-bottom:1px solid var(--line);position:sticky;top:0}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left}
    tbody tr:nth-child(even){background:#f7f9ff}
    .right{text-align:right}

    /* ==== FAB & Panel ==== */
    .quickview-fab{
      position:fixed; right:20px; bottom:24px; z-index:60;
      display:flex; align-items:center; gap:10px;
      background:linear-gradient(135deg,#0d47a1,#1976d2);
      color:#fff; border:none; border-radius:999px; padding:12px 16px;
      box-shadow:0 12px 30px rgba(3,43,108,.24), 0 6px 12px rgba(3,43,108,.18);
      font-weight:700; letter-spacing:.2px; cursor:pointer; transition:.25s transform;
    }
    .quickview-fab:hover{ transform:translateY(-2px); }
    .quickview-fab svg{ width:20px; height:20px; opacity:.92 }

    .qv-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.18); display:none; z-index:58; }
    .qv-backdrop.open{ display:block; }

    .quickview-panel{
      position:fixed; right:20px; bottom:88px; z-index:59; width:min(460px,92vw);
      background:#ffffff; border:1px solid #e7eef8; border-radius:16px;
      box-shadow:0 20px 40px rgba(12,46,96,.18),0 8px 16px rgba(12,46,96,.12);
      padding:14px; display:none; backdrop-filter:saturate(140%) blur(6px);
      font-feature-settings: "tnum" 1;
    }
    .quickview-panel.open{ display:block; animation:panelIn .18s ease-out }
    @keyframes panelIn{ from{ transform:translateY(8px); opacity:.0 } to{ transform:translateY(0); opacity:1 } }

    .quickview-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .quickview-title h4{ margin:0; font-weight:800; color:#0a2257 }
    .quickview-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .quickview-grid{ grid-template-columns:1fr } }

    .qv-chip{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:11px 12px; border:1px solid #e6eef8; border-radius:12px;
      background:linear-gradient(180deg,#f9fbff,#f6f9ff);
      color:#0d2a5a; font-weight:700; cursor:pointer;
      box-shadow:0 1px 0 #eef3fb inset; transition:.2s transform, .25s box-shadow, .25s background;
    }
    .qv-chip .sub{ font-size:.82rem; color:#5b7cad; font-weight:700; background:#eaf2ff; padding:2px 8px; border-radius:999px; min-width:72px; text-align:center}
    .qv-chip:hover{ transform:translateY(-1px); box-shadow: 0 10px 22px rgba(22,58,126,.10), 0 1px 0 #eef3fb inset; background:linear-gradient(180deg,#fefeff,#f6faff);}

    dialog{border:0;border-radius:14px;box-shadow:0 30px 60px rgba(2,28,68,.25)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .month-grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
    .pill{display:flex;justify-content:space-between;background:#f7fbff;border:1px solid #e6eef8;padding:8px 10px;border-radius:10px}
    .year-columns{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:560px){.year-columns{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="app">
  <aside class="side" id="sidebar">
    <div class="brand">
      <img src="probation-logo-green.png" alt="logo">
      <div>
        <div style="font-weight:800;letter-spacing:.2px">คุมประพฤติ เขต 2</div>
        <div style="font-size:12px;color:#cbd8ff">Probation Scheduler</div>
      </div>
    </div>
    <div class="nav">
      <div class="head">เมนู</div>
      <a href="#" onclick="document.getElementById('startDate').focus()">ตั้งค่าวันเริ่ม</a>
      <a href="#" onclick="document.getElementById('presetArea').focus()">เลือกอำเภอ</a>
      <a href="#" onclick="alert('วิธีใช้: ตั้งวันเริ่ม เลือกช่วงห่าง เลือกอำเภอ (ถ้าต้องใช้วันล็อก) แล้วดูผลลัพธ์ 4 ครั้งใน 1 ปี')">วิธีใช้งาน</a>
    </div>
  </aside>

  <section class="main">
    <header class="top">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="hamb" onclick="document.getElementById('sidebar').classList.toggle('open')">☰</button>
        <h1 style="font-size:18px">Website คำนวนวันรายงานตัวผู้ถูกคุมประพฤติ จังหวัดเชียงราย เขต 2</h1>
      </div>
      <div class="actions">
        <button class="btn" id="btn-copy">คัดลอก CSV</button>
        <button class="btn" id="btn-download">ดาวน์โหลด CSV</button>
        <button class="btn primary" id="btn-print">พิมพ์</button>
      </div>
    </header>

    <div class="content">
      <div class="grid">
        <div class="card">
          <h2>ตั้งค่าหลัก</h2>
          <div class="row">
            <label><span>วันที่มีคำพิพากษา</span><input type="date" id="startDate" /></label>
          </div>
          <div class="row">
            <label><span>ช่วงห่าง (เดือน)</span><input type="number" id="intervalMonths" min="1" value="4"/></label>
          </div>
          <div class="row">
            <label><span>พื้นที่ (ตัวเลือกวันประจำเดือน)</span>
              <select id="presetArea">
                <option value="">— ไม่ใช้ตัวเลือกอำเภอ —</option>
                <option value="wiangchai-686970">เวียงชัย (รวมปี 2568–2569–2570)</option>
                <option value="phan-686970">พาน (รวมปี 2568–2569–2570)</option>
                <option value="wiangchiangrung-686970">เวียงเชียงรุ้ง (รวมปี 2569–2570)</option>
                <option value="doiluang-686970">ดอยหลวง (รวมปี 2569–2570)</option>
                <option value="maesuai-686970">แม่สรวย (รวมปี 2568–2569–2570)</option>
                <option value="maelao-686970">แม่ลาว (รวมปี 2568–2569–2570)</option>
                <option value="wiangpapao-686970">เวียงป่าเป้า (รวมปี 2569–2570)</option>
                <option value="watpangae-686970">วัดป่าแงะ (รวมปี 2569–2570)</option>
              </select>
            </label>
          </div>
          <div class="row inline">
            <input type="checkbox" id="lockDay" />
            <label for="lockDay">ล็อกวันที่ของเดือน (เช่น ทุกครั้งวันที่ 5)</label>
          </div>
          <div class="row" id="lockDayWrap" style="display:none">
            <label><span>กำหนดวันที่ (1–31)</span><input type="number" id="lockedDay" min="1" max="31" value="5"/>
              <div class="note">*ถ้าเดือนไม่มีวันดังกล่าว จะใช้วันสุดท้ายของเดือน</div>
            </label>
          </div>
          <div class="row inline">
            <input type="checkbox" id="shiftBiz" checked />
            <label for="shiftBiz">ถ้าตรงเสาร์-อาทิตย์/วันหยุดราชการ ให้เลื่อนไปวันทำการถัดไป</label>
          </div>

          <div class="note">
            กติกา: ต้องได้ <b>4 ครั้งภายใน 1 ปี</b> เสมอ • ถ้าเดือนไม่พอ ระบบจะจัดรอบใหม่ให้อยู่ก่อนครบปี (เดือนไม่เกิน 11)
          </div>
        </div>

        <div class="card">
          <h2>การคำนวณวันรายงานตัวผู้ถูกคุมประพฤติจังหวัดเชียงราย เขตพื้นที่ 2</h2>
          <div class="row">
            <label><span>จำนวนครั้งรายงานตัว</span><input type="number" id="count" min="1" max="4" value="4"/></label>
          </div>
          <div class="note">ระบบจะจัดให้ครบ 4 ครั้งภายใน 1 ปี โดยอาจย่นรอบและ/หรือขยับ “ครั้งที่ 4” ไม่เกินเดือนที่ 11</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>ผลการคำนวณ</strong>
          <span id="limitNote" style="color:var(--muted);font-size:12px">โซนเวลา: Asia/Bangkok</span>
        </div>
        <div class="table-wrap">
          <table id="resultTable">
            <thead><tr><th>ครั้ง</th><th>วันที่รายงานตัว (ไทย)</th><th>วันที่ (ISO)</th><th>วัน</th><th class="right">เหลืออีก (วัน)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="side-mask" onclick="document.getElementById('sidebar').classList.remove('open')"></div>
  </section>
</div>

<!-- Floating Quick View -->
<div class="qv-backdrop" id="qv-backdrop"></div>
<button class="quickview-fab" id="qv-fab" aria-expanded="false" title="ดูวันรายเดือน (ปี 69–70)">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
    <circle cx="12" cy="12" r="10"/>
    <path d="M8 12h8M12 8v8"/>
  </svg> ดูวันรายเดือน
</button>
<div class="quickview-panel" id="qv-panel" role="dialog" aria-modal="true" aria-labelledby="qv-title">
  <div class="quickview-title">
    <h4 id="qv-title">ดูวันรายเดือน ปี 2569–2570</h4>
    <button class="btn" id="qv-close" aria-label="ปิดเมนูดูวันรายเดือน">ปิด</button>
  </div>
  <div class="quickview-grid">
    <button class="qv-chip" id="qv-wpp"><span>เวียงป่าเป้า</span><span class="sub">ปี 69–70</span></button>
    <button class="qv-chip" id="qv-wpn"><span>วัดป่าแงะ</span><span class="sub">ปี 69–70</span></button>
    <button class="qv-chip" id="qv-msr"><span>แม่สรวย</span><span class="sub">ปี 69–70</span></button>
    <button class="qv-chip" id="qv-mla"><span>แม่ลาว</span><span class="sub">ปี 69–70</span></button>
    <button class="qv-chip" id="qv-wcrdl"><span>เวียงเชียงรุ้ง / ดอยหลวง</span><span class="sub">ปี 69–70</span></button>

    <!-- เวียงชัย / พาน — รวมปี 69–70 -->
    <button class="qv-chip" id="qv-wc"><span>เวียงชัย</span><span class="sub">ปี 69–70</span></button>
    <button class="qv-chip" id="qv-phan"><span>พาน</span><span class="sub">ปี 69–70</span></button>
  </div>
</div>

<!-- === DIALOGS (ทุกอำเภอใช้ dialog แบบเดียวกัน) === -->
<!-- Template structure: Title, two year columns (2569/2570) with month pill list and copy buttons -->

<dialog id="dlg-wpp">
  <div class="modal-head"><strong>วันรายเดือน เวียงป่าเป้า (ปี 2569–2570)</strong><button class="btn" data-close="dlg-wpp">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-wpp-2569"></div><button class="btn" id="copy-wpp-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-wpp-2570"></div><button class="btn" id="copy-wpp-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-wpn">
  <div class="modal-head"><strong>วันรายเดือน วัดป่าแงะ (ปี 2569–2570)</strong><button class="btn" data-close="dlg-wpn">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-wpn-2569"></div><button class="btn" id="copy-wpn-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-wpn-2570"></div><button class="btn" id="copy-wpn-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-msr">
  <div class="modal-head"><strong>วันรายเดือน แม่สรวย (ปี 2569–2570)</strong><button class="btn" data-close="dlg-msr">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-msr-2569"></div><button class="btn" id="copy-msr-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-msr-2570"></div><button class="btn" id="copy-msr-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-mla">
  <div class="modal-head"><strong>วันรายเดือน แม่ลาว (ปี 2569–2570)</strong><button class="btn" data-close="dlg-mla">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-mla-2569"></div><button class="btn" id="copy-mla-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-mla-2570"></div><button class="btn" id="copy-mla-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-wcrdl">
  <div class="modal-head"><strong>วันรายเดือน เวียงเชียงรุ้ง / ดอยหลวง (ปี 2569–2570)</strong><button class="btn" data-close="dlg-wcrdl">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-wcrdl-2569"></div><button class="btn" id="copy-wcrdl-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-wcrdl-2570"></div><button class="btn" id="copy-wcrdl-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-wc">
  <div class="modal-head"><strong>วันรายเดือน เวียงชัย (ปี 2569–2570)</strong><button class="btn" data-close="dlg-wc">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-wc-2569"></div><button class="btn" id="copy-wc-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-wc-2570"></div><button class="btn" id="copy-wc-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<dialog id="dlg-phan">
  <div class="modal-head"><strong>วันรายเดือน พาน (ปี 2569–2570)</strong><button class="btn" data-close="dlg-phan">ปิด</button></div>
  <div class="year-columns">
    <div><div class="note" style="margin-bottom:6px">ปี 2569</div><div class="month-grid" id="grid-phan-2569"></div><button class="btn" id="copy-phan-2569" style="margin-top:8px">คัดลอกปี 2569</button></div>
    <div><div class="note" style="margin-bottom:6px">ปี 2570</div><div class="month-grid" id="grid-phan-2570"></div><button class="btn" id="copy-phan-2570" style="margin-top:8px">คัดลอกปี 2570</button></div>
  </div>
</dialog>

<script>
  // ---------- data (lock-day presets) ----------
  const presets = {
    "wiangchai-686970": { years: {
      2025:[20,17,24,28,19,23,29,25,22,27,17,22],
      2026:[26,23,30,27,25,29,27,31,28,27,23,28],
      2027:[25,23,22,26,25,21,26,23,27,26,22,27]
    }},
    "phan-686970": { years: {
      2025:[23,20,20,18,22,19,17,21,18,16,20,18],
      2026:[22,19,19,23,21,18,16,20,17,15,20,17],
      2027:[21,18,22,20,17,22,19,23,21,18,23,23]
    }},
    "maesuai-686970": { years: {
      2025:[21,18,18,22,20,17,15,19,16,21,18,16],
      2026:[20,17,17,21,19,16,14,18,15,13,17,15],
      2027:[19,16,16,20,18,15,20,17,21,19,16,21]
    }},
    "maelao-686970": { years: {
      2025:[23,20,20,18,22,19,17,21,18,16,20,18],
      2026:[13,10,10,8,12,9,7,11,8,6,10,8],
      2027:[12,9,9,7,11,8,13,10,14,12,9,14]
    }},
    "wiangpapao-686970": { years: {
      2026:[8,12,12,9,14,11,9,13,10,8,12,9],
      2027:[14,11,11,8,13,10,15,13,16,14,11,16]
    }},
    "watpangae-686970": { years: {
      2026:[29,26,26,24,28,25,23,27,24,26,26,24],
      2027:[28,25,25,29,27,24,29,26,30,28,25,30]
    }},
    "wiangchiangrung-686970": { years: {
      2026:[13,10,17,21,13,16,21,18,15,20,11,15],
      2027:[18,15,15,19,17,14,19,16,20,18,15,20]
    }},
    "doiluang-686970": { years: {
      2026:[13,10,17,21,13,16,21,18,15,20,11,15],
      2027:[18,15,15,19,17,14,19,16,20,18,15,20]
    }}
  };

  // ---------- helpers ----------
  const tz='Asia/Bangkok';
  const startOfDay=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x}
  const lastDayOfMonth=(y,m)=>new Date(y,m+1,0).getDate();
  const fmtTH=d=>new Intl.DateTimeFormat('th-TH',{dateStyle:'full',timeZone:tz}).format(d);
  const fmtISO=d=>{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`};
  const weekdayTH=d=>new Intl.DateTimeFormat('th-TH',{weekday:'long',timeZone:tz}).format(d);
  const monthsBetween=(a,b)=>(b.getFullYear()-a.getFullYear())*12+(b.getMonth()-a.getMonth());
  const addMonthsClamp=(date,months,desiredDay=null)=>{const y=date.getFullYear(),m=date.getMonth(),d=date.getDate();const tm=m+months,ty=y+Math.floor(tm/12),mm=((tm%12)+12)%12;const want=desiredDay??d;const max=lastDayOfMonth(ty,mm);const fd=Math.min(want,max);const out=new Date(ty,mm,fd);out.setHours(0,0,0,0);return out};

  const TH_HOLIDAYS = new Set([
    '2025-01-01','2025-02-12','2025-04-06','2025-04-07','2025-04-13','2025-04-14','2025-04-15','2025-05-01','2025-05-05','2025-06-03','2025-07-18','2025-07-19','2025-07-28','2025-08-12','2025-10-13','2025-10-23','2025-12-05','2025-12-10','2025-12-31',
    '2026-01-01','2026-02-01','2026-04-06','2026-04-13','2026-04-14','2026-04-15','2026-05-01','2026-05-05','2026-06-03','2026-07-27','2026-07-28','2026-07-29','2026-07-30','2026-08-12','2026-10-13','2026-10-23','2026-12-05','2026-12-10','2026-12-31',
    '2027-01-01','2027-02-20','2027-02-21','2027-04-06','2027-04-13','2027-04-14','2027-04-15','2027-05-01','2027-05-05','2027-06-03','2027-07-19','2027-07-20','2027-07-28','2027-08-12','2027-10-13','2027-10-23','2027-12-05','2027-12-10','2027-12-31'
  ]);
  const isWeekend=d=>d.getDay()===0||d.getDay()===6;
  const isThaiHoliday=d=>TH_HOLIDAYS.has(fmtISO(d));
  const isNonWorkingDay=d=>isWeekend(d)||isThaiHoliday(d);
  const nextBusinessDay=d=>{const x=new Date(d);while(isNonWorkingDay(x)){x.setDate(x.getDate()+1)}return x};

  // DOM
  const startDateEl=document.getElementById('startDate'),
        intervalEl=document.getElementById('intervalMonths'),
        presetAreaEl=document.getElementById('presetArea'),
        lockDayEl=document.getElementById('lockDay'),
        lockedDayEl=document.getElementById('lockedDay'),
        shiftBizEl=document.getElementById('shiftBiz'),
        countEl=document.getElementById('count'),
        tbody=document.querySelector('#resultTable tbody'),
        limitNote=document.getElementById('limitNote');

  function lockedByPresetKey(presetKey, y, m){
    const p = presets[presetKey];
    if(!p || !p.years || !p.years[y]) return null;
    const arr = p.years[y];
    const d = Math.min(arr[m], lastDayOfMonth(y,m));
    if(!d || isNaN(d)) return null;
    const dt = new Date(y, m, d); dt.setHours(0,0,0,0); return dt;
  }
  function applyPreset(dateObj){
    const key = presetAreaEl.value;
    if(!key) return dateObj;
    return lockedByPresetKey(key, dateObj.getFullYear(), dateObj.getMonth()) || dateObj;
  }

  // render year-month list into a target grid
  function renderYearGrid(year, key, gridEl){
    gridEl.innerHTML='';
    const monthsTH=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
    const arr=(presets[key] && presets[key].years && presets[key].years[year])
  ? [...presets[key].years[year]]
  : [];
    monthsTH.forEach((name,i)=>{
      const div=document.createElement('div'); div.className='pill';
      div.innerHTML=`<span>${i+1}. ${name}</span><strong>${arr[i] ?? '-'}</strong>`; gridEl.appendChild(div);
    });
  }
  function copyYear(year, key, title){
    const short=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    const arr=presets[key].years[year];
    const txt=short.map((m,i)=>`${m} ${arr[i]}`).join(', ');
    navigator.clipboard.writeText(`${title}: ${txt}`).then(()=>alert('คัดลอกแล้ว'));
  }

  // schedule table compute
  const tzNowText = `โซนเวลา: ${tz}`;
  function toCSV(rows){
    const header=["ครั้ง","วันที่รายงานตัว (ไทย)","วันที่ (ISO)","วัน","เหลืออีก (วัน)"];
    const body=rows.map(r=>[r.index,r.th,r.iso,r.weekday,r.daysLeft]);
    return [header,...body].map(line=>line.map(x=>(''+x).replaceAll('"','""')).map(x=>`"${x}"`).join(',')).join('\\n');
  }
  const startOfDayFn = startOfDay;
  function computeRows(){
    const start=startOfDayFn(new Date(startDateEl.value||new Date()));
    const gap=Math.max(1,parseInt(intervalEl.value||'4',10));
    const count=Math.min(4,Math.max(1,parseInt(countEl.value||'4',10)));
    const usePreset=!!presetAreaEl.value;
    const lockedDay=(lockDayEl.checked && !usePreset) ? Math.max(1,Math.min(31,parseInt(lockedDayEl.value||'5',10))) : null;
    const shiftBiz=shiftBizEl.checked;
    const oneYearLimit=addMonthsClamp(start,12,null);
    const lastAllowed=addMonthsClamp(start,11,null);

    let first;
    if(usePreset){
      const curLocked=applyPreset(start);
      let base=start;
      if(start.getTime()>curLocked.getTime()){ base=addMonthsClamp(start,1,null); }
      first=addMonthsClamp(new Date(base.getFullYear(), base.getMonth(), 1), gap, 1);
      first=applyPreset(first);
    }else{
      first=addMonthsClamp(start, gap, lockedDay);
    }

    let rows=[]; let cur=new Date(first);
    const push=(dt)=>{ let d=new Date(dt); if(usePreset) d=applyPreset(d); else if(lockedDay!=null){ const y=d.getFullYear(),m=d.getMonth(); d=new Date(y,m,Math.min(lockedDay,lastDayOfMonth(y,m))); } if(shiftBiz) d=nextBusinessDay(d); if(d>oneYearLimit) return false; rows.push(d); return true; };
    if(!push(cur)) rows=[];
    while(rows.length<count){ cur=addMonthsClamp(cur, gap, lockedDay); if(!push(cur)) break; }

    const okLast = rows.length===count && rows[rows.length-1] <= lastAllowed;
    if(!okLast){
      let targetLast = usePreset ? applyPreset(lastAllowed) : new Date(lastAllowed);
      if(!usePreset && lockedDay!=null){ targetLast = new Date(lastAllowed.getFullYear(), lastAllowed.getMonth(), Math.min(lockedDay,lastDayOfMonth(lastAllowed.getFullYear(), lastAllowed.getMonth()))); }
      if(shiftBiz) targetLast=nextBusinessDay(targetLast);

      const earliestFirst=new Date(first);
      const span=Math.max(0, monthsBetween(earliestFirst, targetLast));
      let step=Math.max(1, Math.floor((span-1)/3));
      let t1=new Date(earliestFirst);
      let t2=addMonthsClamp(t1, step, lockedDay);
      let t3=addMonthsClamp(t2, step, lockedDay);
      let t4=new Date(targetLast);
      if(usePreset){ t1=applyPreset(t1); t2=applyPreset(t2); t3=applyPreset(t3); t4=applyPreset(t4); }
      if(shiftBiz){ t1=nextBusinessDay(t1); t2=nextBusinessDay(t2); t3=nextBusinessDay(t3); t4=nextBusinessDay(t4); }
      rows=[t1,t2,t3,t4].filter(d=>d<=oneYearLimit);
    }

    const today=startOfDayFn(new Date());
    limitNote.textContent=`จำกัดภายใน 1 ปี (ไม่เกิน ${fmtTH(oneYearLimit)})`;
    return rows.map((d,i)=>({index:i+1, th:fmtTH(d), iso:fmtISO(d), weekday:weekdayTH(d), daysLeft:Math.ceil((d-today)/(1000*60*60*24))}));
  }
  function updateSchedule(){
    const rows=computeRows();
    const tbody=document.querySelector('#resultTable tbody');
    tbody.innerHTML='';
    const frag=document.createDocumentFragment();
    rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.index}</td><td>${r.th}</td><td>${r.iso}</td><td>${r.weekday}</td><td class="right">${r.daysLeft}</td>`; frag.appendChild(tr)});
    tbody.appendChild(frag);
  }
  function copyCSV(){ const rows=computeRows(); const csv=toCSV(rows); navigator.clipboard.writeText(csv).then(()=>alert('คัดลอก CSV แล้ว')); }
  function downloadCSV(){ const rows=computeRows(); const csv=toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='probation-schedule-v28-dialogs.html.csv'; a.click(); URL.revokeObjectURL(url); }

  (function init(){
    const today=startOfDay(new Date());
    startDateEl.value = fmtISO(today);
    updateSchedule();

    ['input','change'].forEach(ev=>[startDateEl,intervalEl,presetAreaEl,lockDayEl,lockedDayEl,shiftBizEl,countEl].forEach(el=>el.addEventListener(ev,updateSchedule)));
    lockDayEl.addEventListener('change',()=>{document.getElementById('lockDayWrap').style.display=lockDayEl.checked?'':'none'});

    document.getElementById('btn-print').addEventListener('click',()=>window.print());
    document.getElementById('btn-copy').addEventListener('click',copyCSV);
    document.getElementById('btn-download').addEventListener('click',downloadCSV);

    // FAB toggle & close
    const fab  = document.getElementById('qv-fab');
    const panel= document.getElementById('qv-panel');
    const close= document.getElementById('qv-close');
    const bd   = document.getElementById('qv-backdrop');
    function openPanel(){ panel.classList.add('open'); bd.classList.add('open'); fab.setAttribute('aria-expanded','true'); }
    function closePanel(){ panel.classList.remove('open'); bd.classList.remove('open'); fab.setAttribute('aria-expanded','false'); }
    fab.addEventListener('click', ()=> (panel.classList.contains('open')? closePanel():openPanel()));
    close.addEventListener('click', closePanel);
    bd.addEventListener('click', closePanel);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closePanel(); });

    // Helper to wire a dialog with two years
    function wireDialog(chipId, dialogId, key){
      const chip=document.getElementById(chipId);
      const dlg=document.getElementById(dialogId);
      const gridA=document.getElementById(`grid-${key.replace('-686970','')}-2569`);
      const gridB=document.getElementById(`grid-${key.replace('-686970','')}-2570`);
      chip.addEventListener('click', ()=>{
        // Render 2569 (Gregorian 2026) and 2570 (2027)
        renderYearGrid(2026,key,gridA);
        renderYearGrid(2027,key,gridB);
        closePanel(); dlg.showModal();
      });
      dlg.querySelector('[data-close="'+dialogId+'"]').addEventListener('click', ()=> dlg.close());
      document.getElementById(`copy-${dialogId.split('dlg-')[1]}-2569`).addEventListener('click', ()=> copyYear(2026,key, chip.textContent.trim()+' 2569'));
      document.getElementById(`copy-${dialogId.split('dlg-')[1]}-2570`).addEventListener('click', ()=> copyYear(2027,key, chip.textContent.trim()+' 2570'));
    }

    // Wire all dialogs
    wireDialog('qv-wpp','dlg-wpp','wiangpapao-686970');
    wireDialog('qv-wpn','dlg-wpn','watpangae-686970');
    wireDialog('qv-msr','dlg-msr','maesuai-686970');
    wireDialog('qv-mla','dlg-mla','maelao-686970');
    wireDialog('qv-wcrdl','dlg-wcrdl','wiangchiangrung-686970');

    // Combine เวียงชัย & พาน (ปี 69–70)
    wireDialog('qv-wc','dlg-wc','wiangchai-686970');
    wireDialog('qv-phan','dlg-phan','phan-686970');
  })();
</script>

</body>
</html>
